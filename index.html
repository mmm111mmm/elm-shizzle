<head>
  <link rel="stylesheet" href="res/css/normalize.css">
  <link rel="stylesheet" href="res/css/skeleton.css">
  <link rel="stylesheet" href="res/leaflet.css" />
  <meta charset="UTF-8">
  <style>
    #mapid { height: 380px;
             width: 380px;
    }
    body {
      margin: 24px;
    }
  </style>
  <script src="res/leaflet.js"></script>
</head>
<div id="main" style="float: left; margin-right: 70px;"></div>
<script src="main.js"></script>
<script>

      var myIcon = L.icon({
      		iconUrl:       'res/images/marker-icon-orange.png',
      		iconRetinaUrl: 'res/images/marker-icon-orange-2x.png',
      		shadowUrl:     'res/images/marker-shadow.png',
      		iconSize:    [25, 41],
      		iconAnchor:  [12, 41],
      		popupAnchor: [1, -34],
      		tooltipAnchor: [16, -28],
      		shadowSize:  [41, 41]
      });

      var blueIcon = L.icon({
          iconUrl:       'res/images/marker-icon.png',
          iconRetinaUrl: 'res/images/marker-icon-2x.png',
          shadowUrl:     'res/images/marker-shadow.png',
          iconSize:    [25, 41],
          iconAnchor:  [12, 41],
          popupAnchor: [1, -34],
          tooltipAnchor: [16, -28],
          shadowSize:  [41, 41]
      });

    var node = document.getElementById('main');
    var app = Elm.Main.embed(node);

    var mymap;

    app.ports.setupLeaflet.subscribe(setupLeaflet);

    function setupLeaflet(b) {
      mymap = L.map('mapid', {
        center: [53.483873, -2.237027],
        zoom: 15
      });

    	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={token}', {
    		maxZoom: 17,
    		attribution: '',
    		id: 'mapbox.streets',
        token: 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw'
    	}).addTo(mymap);

    }

    app.ports.addLeafletPin.subscribe(addLeafletPin);

    var markers = []

    function addLeafletPin(arg) {
      var [id, title, lat, lon] = arg


      var marker = L.marker([lat, lon]).addTo(mymap);
      markers.push(marker)
      marker.addEventListener("click", function(e) {
        for(var i=0;i<markers.length;i++) {
          markers[i].setIcon(blueIcon);
        }
        console.log(e.target.setIcon(myIcon))
        app.ports.companyClick.send(id);
      })
      mymap.panTo(new L.LatLng(53.483873, -2.237027));
    }

    app.ports.focusOnInput.subscribe(focusOn);

    function focusOn(focusId) {
      window.requestAnimationFrame(function() {
        var t = document.querySelector("[name=techAdd]")
        t.focus()
      })
    }

</script>
