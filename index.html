<head>
  <link rel="stylesheet" href="res/css/normalize.css">
  <link rel="stylesheet" href="res/css/skeleton.css">
  <link rel="stylesheet" href="res/leaflet.css" />
  <meta charset="UTF-8">
  <style>
    #mapid { height: 380px;
             width: 380px;
    }
    body {
      margin: 24px;
    }
  </style>
  <script src="res/leaflet.js"></script>
</head>
<div id="main" style="float: left; margin-right: 70px;"></div>
<script src="main.js"></script>
<script>

      var myIcon = L.icon({
      		iconUrl:       'res/images/marker-icon-orange.png',
      		iconRetinaUrl: 'res/images/marker-icon-orange-2x.png',
      		shadowUrl:     'res/images/marker-shadow.png',
      		iconSize:    [25, 41],
      		iconAnchor:  [12, 41],
      		popupAnchor: [1, -34],
      		tooltipAnchor: [16, -28],
      		shadowSize:  [41, 41]
      });

      var blueIcon = L.icon({
          iconUrl:       'res/images/marker-icon.png',
          iconRetinaUrl: 'res/images/marker-icon-2x.png',
          shadowUrl:     'res/images/marker-shadow.png',
          iconSize:    [25, 41],
          iconAnchor:  [12, 41],
          popupAnchor: [1, -34],
          tooltipAnchor: [16, -28],
          shadowSize:  [41, 41]
      });

    var node = document.getElementById('main');
    var app = Elm.Main.embed(node);

    var mymap;

    app.ports.setupLeaflet.subscribe(setupLeaflet);

    function setupLeaflet(b) {
      mymap = L.map('mapid', {
        center: [53.483873, -2.237027],
        zoom: 12
      });

    	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={token}', {
    		maxZoom: 17,
    		attribution: '',
    		id: 'mapbox.streets',
        token: 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw'
    	}).addTo(mymap);

    }

    var markers = []
    var oldSelected = 0

    app.ports.highlightMarker.subscribe(highlightMarker);

    function highlightMarker(arg) {
      for(var i=0;i<markers.length;i++) {
        if(markers[i].companyId == arg) {
          markers[i].setIcon(myIcon);
          mymap.setView(new L.LatLng(markers[i].lat, markers[i].lon), 13, {"animate": true});
        } else {
          markers[i].setIcon(blueIcon);
        }
      }
    }

    app.ports.addLeafletPins.subscribe(addLeafletPins);

    function addLeafletPins(arg) {
      var companies = arg[0]
      var shouldSelected = arg[1]

      for(var i=0;i<markers.length;i++) {
        mymap.removeLayer(markers[i])
      }

      for(var i = 0; i < companies.length; i++) {
        var company = companies[i]
        var marker = L.marker([company.lat, company.lon]).addTo(mymap);
        if(company.id == oldSelected) marker.setIcon(myIcon)
        marker.companyId = company.id
        marker.lat = company.lat
        marker.lon = company.lon
        markers.push(marker)
        marker.addEventListener("click", function(e) {
          for(var i=0;i<markers.length;i++) {
            markers[i].setIcon(blueIcon);
          }
          e.target.setIcon(myIcon)
          app.ports.companyClick.send(e.target.companyId);
          oldSelected = e.target.companyId
        })
      }
      var cId = markers[0].companyId
      if(shouldSelected!="") cId = shouldSelected
      app.ports.companyClick.send(cId);
      highlightMarker(cId)
    }

    app.ports.focusOnHtml.subscribe(focusOn);

    function focusOn(focusId) {
      window.requestAnimationFrame(function() {
        var t = document.querySelector(focusId)
        if(t) {
          t.focus()
        } else {
          console.debug("couldn't focus on "+ focusId)
        }
      })
    }

</script>
